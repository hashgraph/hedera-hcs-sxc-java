<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
        <meta name="theme-color" content="#000000">

        <!-- Required styles for MDC Web -->
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="styles/custom.css"/>
        
    </head>
    <body>
        <header class="mdc-top-app-bar app-bar mdc-top-app-bar--fixed" id="app-bar">     
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <button href="#" class="demo-menu   mdc-icon-button material-icons  mdc-top-app-bar__navigation-icon">menu</button>
                    <span class="mdc-top-app-bar__title">HCS - Settlement Demo</span>
                </section>
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
                    <div style="position:relative">
                        <button class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Alert">notifications</button>
                        <div id="notification-badge" 
                            style=" 
                             display:none;
                             width:20px;
                             height:20px;
                             line-height: 20px;
                             text-align: center;
                             font-size: 10px;
                             font-weight: bold;
                             font-family: Roboto;
                             border-radius: 50%;
                             position:absolute; 
                             background-color: red;
                             top:5px;
                             right:5px;
                             ">
                            0
                        </div>
                    </div>
                    <button class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Print this page">print</button>
                    <button 
                        onclick="recreateData()"
                        class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Recreate all date">delete_sweep</button>
                </section>
            </div>           
        </header>

        <aside id="left-drawer" class="mdc-drawer mdc-drawer--dismissible   mdc-top-app-bar--fixed-adjust">
            <div class="mdc-drawer__content">
                <header class="mdc-top-app-bar  mdc-top-app-bar--fixed mdc-theme--primary
                        " 
                        style="background-color: #fafafa;
                        border-bottom: 1px solid rgba(0,0,0,.12);
                        "
                        id="app-bar-of-main-content">     
                    <div class="mdc-top-app-bar__row">
                        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                            <span id="this-user"
                                  class="mdc-top-app-bar__title
                                  mdc-typography--body1
                                  "
                                  style="padding: 8px"
                                  >Alice</span>
                            <span 
                                id="this-pk"
                                class="overflow-elipsis mdc-typography--body1"
                                title="302fdsadfsafdsadfsadfsdfsadfsadfsadf">
                                PK 302fdsadfsafdsadfsadfsdfsadfsadfsadf
                            </span>
                        </section>
                    </div>           
                </header>
                <div  id="lhs-menu" class="mdc-list  mdc-top-app-bar--fixed-adjust">

                    <a class="mdc-list-item mdc-list-item--activated" href="#overview">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
                        <span class="mdc-list-item__text">Overview</span>
                    </a>
                    <a class="credits-and-debits mdc-list-item" href="#credits-and-debits" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">money</i>
                        <span class="mdc-list-item__text">Credits and Debits</span>
                    </a>
                    <a class="settlements mdc-list-item " href="#settlements" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">verified_user</i>
                        <span class="mdc-list-item__text">Settlements</span>
                    </a>
<!--                    <a class="mdc-list-item" href="#addresses" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">group</i>
                        <span class="mdc-list-item__text">Addresses</span>
                    </a>-->
                    <a class="audit mdc-list-item" href="#audit" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">remove_red_eye</i>
                        <span class="mdc-list-item__text">Audit</span>
                    </a>
                    <div role="separator" class="mdc-list-divider"></div>
<!--                    <a class="mdc-list-item" href="#" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">account_box</i>
                        <span class="mdc-list-item__text">Account</span>
                    </a>-->
                </div>
            </div>
        </aside>
        <div class="mdc-drawer-app-content mdc-top-app-bar--fixed-adjust">
            <main class="main-content" id="main-content">

                <header class="mdc-top-app-bar  mdc-top-app-bar--fixed 
                        mdc-theme--primary
                        " 
                        style="background: white; box-shadow: 0 4px 4px -2px gray;"
                        id="app-bar-of-main-content">     
                    <div class="mdc-top-app-bar__row">
                        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                            <b id="header-title" class="mdc-top-app-bar__title ">
                                Overview
                            </b>
                        </section>
                    </div>           
                </header>
                <template id="credits-and-debits-panel" >
                    
                    <div id="{{username}}" class="panel">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate	mdc-linear-progress--closed" aria-label="Example Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffering-dots"></div>
                            <div class="mdc-linear-progress__buffer"></div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>      
                        
                        <details>
                            <summary>
                                <div class="message-container" style="margin-left:55px; margin-right: 16px;">
                                    <div style="display: flex">
                                        <span 
                                            id="credits-and-debits-user"
                                            class="mdc-typography--headline6" style="flex-grow:1">
                                            {{username}}
                                        </span>
                                        <button 
                                            id="new-credit-button"
                                            role="open-new-credit-button-dialog"
                                            class="mdc-button mdc-button--unelevated">
                                            new credit
                                        </button>
                                    </div>
                                </div>
                            </summary>
                            <div class="content"
                                 style="overflow-x: scroll"
                                 >
                                <div class="mdc-data-table" style="width:100%">
                                    <table class="mdc-data-table__table" aria-label="Dessert calories">
                                        <thead>
                                            <tr class="mdc-data-table__header-row">
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"><button id="settle-now-button" disabled class="mdc-button mdc-button--outlined">Settle</button></th>
                                                
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Payer</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Recipient</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Reference</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Amount</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">DateTime</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Actions</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="credit-table-body" class="mdc-data-table__content">
                                            <template id="credit-table-body-template">
                                                <tr class="mdc-data-table__row">
                                                    <td id="settlebox" class="mdc-data-table__cell"  style="text-align: center">
                                                        <div id="settle-check"  style="visibility: hidden;" class="mdc-checkbox">
                                                            <input type="checkbox"
                                                                   disabled
                                                                   class="mdc-checkbox__native-control"
                                                                   id="checkbox-1"/>
                                                            <div class="mdc-checkbox__background">
                                                              <svg class="mdc-checkbox__checkmark"
                                                                   viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path"
                                                                      fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                              </svg>
                                                              <div class="mdc-checkbox__mixedmark"></div>
                                                            </div>
                                                            <div class="mdc-checkbox__ripple"></div>
                                                          </div>
                                                    </td>
                                                    <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                                    <td id="payer"          class="mdc-data-table__cell">Alice</td>
                                                    <td id="recipient"      class="mdc-data-table__cell">Bob</td>
                                                    <td id="reference"      class="mdc-data-table__cell">A77U312</td>
                                                    <td id="amount"         class="mdc-data-table__cell" data-amount="120" data-currency="USD">$120</td>
                                                    <td id="date-time"           class="mdc-data-table__cell">13 Nov 9:21</td>
                                                    <td id="status"         class="mdc-data-table__cell">Pending</td>
                                                    <td id="action"         class="mdc-data-table__cell"></td>
                                                    <td id="notes"          class="mdc-data-table__cell">1 x XYZ Service</td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                        </details>
                            
                    </div>
                </template>
                
                <template id="settlements-panel" >
                    
                    <div id="{{username}}" class="panel">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate	mdc-linear-progress--closed" aria-label="Example Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffering-dots"></div>
                            <div class="mdc-linear-progress__buffer"></div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>      
                        
                        <details>
                            <summary>
                                <div class="message-container" style="margin-left:55px; margin-right: 16px;">
                                    <div style="display: flex">
                                        <span 
                                            id="settlements-user"
                                            class="mdc-typography--headline6" style="flex-grow:1">
                                            {{username}}
                                        </span>
                                        
                                    </div>
                                </div>
                            </summary>
                            <div class="content"
                                 style="overflow-x: scroll"
                                 >
                                <div class="mdc-data-table" style="width:100%">
                                    <table class="mdc-data-table__table" aria-label="">
                                        <thead>
                                            <tr class="mdc-data-table__header-row">
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Payer</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Recipient</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Reference</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Amount (USD)</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">DateTime</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                                <!--<th class="mdc-data-table__header-cell" role="columnheader" scope="col">Channel</th>-->
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Actions</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="settlement-table-body" class="mdc-data-table__content">
                                            <template id="settlement-table-body-template">
                                                <tr class="mdc-data-table__row">
                                                    <td id="row-role" class="mdc-data-table__cell"  style="text-align: left">
                                                    </td>
                                                    <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                                    <td id="payer"          class="mdc-data-table__cell">Alice</td>
                                                    <td id="recipient"      class="mdc-data-table__cell">Bob</td>
                                                    <td id="reference"      class="mdc-data-table__cell">A77U312</td>
                                                    <td id="amount-net"     class="mdc-data-table__cell" style="text-align: right" data-amount="120" data-currency="USD">$120</td>
                                                    <td id="date-time"           class="mdc-data-table__cell">13 Nov</td>
                                                    <td id="status"         class="mdc-data-table__cell">Pending</td>
                                                    <!--<td id="channel-name"   class="mdc-data-table__cell"></td>-->
                                                    <td id="action"         class="mdc-data-table__cell"></td>
                                                    <td id="notes"          class="mdc-data-table__cell">1 x XYZ Service</td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                        </details>
                            
                    </div>
                </template>
                
                <template id="audit-table-template">
                    <div class="mdc-data-table" style="width:100%">
                        <table class="mdc-data-table__table" aria-label="Dessert calories">
                            <thead>
                                <tr class="mdc-data-table__header-row">
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Context</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">TopicId</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Date</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Time</th>
                                    <th></th>
                                </tr>
                            </thead>
                            
                            
                             <tbody id="audit-table-body" class="mdc-data-table__content">
                                    <template id="audit-table-body-template">
                                        <tr class="mdc-data-table__row">
                                            <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                            <td id="context"          class="mdc-data-table__cell">Credits</td>
                                            <td id="status"         class="mdc-data-table__cell">Pending</td>
                                            <td id="topicId"         class="mdc-data-table__cell">0.0.1004</td>
                                            <td id="createdDate"           class="mdc-data-table__cell">13 Nov</td>
                                            <td id="createdTime"           class="mdc-data-table__cell">09:31</td>
                                            <td id="action"              class="mdc-data-table__cell" style="text-align: right"> <a id="audit-table-row-expand" class="mdc-button"><i class="material-icons mdc-button__icon">remove_red_eye</i></a> </td>
                                        </tr>
                                    </template>
                            </tbody>
                        </table>
                    </div>
                </template>
                
                <template id="audit-thread-template">
                    <div class="panel">
                        <details>
                            <summary>
                                <div  style="display:flex; flex-direction: column; margin-left: 64px;">
                                    <div style="display: flex; ">
                                        <div style="padding: 16px"><b>Application Message ID:</b></div>
                                        <div style="padding: 16px" id="audit-thread-message-id">0.0.1010-1575314109-166076700</div>
                                    </div>
                                    <div style="padding: 16px; padding-top:8px" id="audit-thread-message-text">threadId: \"1575314119-166076700\"\ncredit ...</div>
                                </div>
                            </summary>
                            <div  class="content" style="overflow-x:scroll; background-color: #fafafa">
                                <pre  style="padding: 16px;" id="audit-thread-message-parts-json">
                                {"auditHCSMessages":[{"consensusTimeStampSeconds":1575314126,"consensusTimeStampNanos":919509001,"runningHash":"�_��:\u0005��]\u0004y9���\u0001\u0007)f��Ԓ����õ[_)9���+\u001E�\r9\u001FT�����","sequenceNumber":774,"message":"applicationMessageId {\n  validStart {\n    seconds: 1575314109\n    nanos: 166076700\n  }\n  accountID {\n    accountNum: 1010\n  }\n}\nbusinessProcessMessage: \"\\n\\0241575314119-166076700\\022:\\n\\005Alice\\022\\006Carlos\\032\\adsfafds\\\"\\b\\n\\003USD\\020\\241`*\\basfdsadf:\\0052 DecB\\00519:15\"\n","part":"1 of 1"}]}
                                </pre>
                            </div>
                        </details>
                    </div>
                </template>
                
                
                <div 
                    id="main-panel-holder"
                    class="flippanel mdc-top-app-bar--fixed-adjust mdc-typography--body2"
                     style='margin: 16px 32px;'
                    >
                </div>
            </main>
        </div>

        <div id="new-credit-dialog" 
           
            class="mdc-dialog"
             role="alertdialog"
             aria-modal="true"
             aria-labelledby="my-dialog-title"
             aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">


                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->New Credit<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                        
                        <div style="display:fex; flex-direction: column">
                            <form id="new-credit-dialog-form">
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" disabled id="new-credit-recipient"
                                           value="{{newCreditRecipient}}"
                                           required
                                           class="mdc-text-field__input ">
                                    <label class="mdc-floating-label" for="my-text-field">
                                        Recipient 
                                    </label>
                                </div>
                                
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" id="new-credit-service-reference" 
                                           required minlength=4
                                           class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="">
                                        Service Reference
                                    </label>
                                </div>   
                                <div class="mdc-text-field-helper-line">
                                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">
                                        Field is required and must be at least 4 characters long
                                    </div>
                                </div>
                                
                                <div class="mdc-text-field  mdc-text-field--with-leading-icon  mdc-text-field--full-width">
                                    <i class="material-icons mdc-text-field__icon">money</i>
                                    <input type="number" 
                                           id="new-credit-amount"
                                           required
                                           id="my-text-field" class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="new-credit-amount">
                                        Amount
                                    </label>
                                </div>   
                                
                                <div class="mdc-text-field-helper-line">
                                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">
                                        Field is required and must be a number without decimals
                                    </div>
                                </div>
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text"
                                           id="new-credit-additional-notes"
                                           required minlength=4
                                           id="my-text-field" class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="new-credit-additional-notes">
                                        Additional Notes
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field-helper-line">
                                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">
                                        Field is required and must be at least 4 characters long
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
            
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button type="button" 
                                id="send-new-credit-dialog-submit"
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
>
                            <span class="mdc-button__label">Send Now</span>
                        </button>
                    </footer>
                </div>

            </div>
        </div><div class="mdc-dialog-scrim"></div>

        
        <div id="confirm-credit-dialog" 
           
            class="mdc-dialog"
             role="alertdialog"
             aria-modal="true"
             aria-labelledby="my-dialog-title"
             aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">

                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->Confirm Credit<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                        Do you accept this credit?
                    </div>
                    <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text"
                                           id="thread-id"
                                           value="{{threadId}}"
                                           disabled
                                           class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="thread-id">
                                        ThreadId
                                    </label>
                    </div>
                  
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button type="button" 
                                id="confirm-credit-send"
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
                        >
                            <span class="mdc-button__label">Confirm</span>
                        </button>
                    </footer>
                </div>

            </div>
        </div><div class="mdc-dialog-scrim"></div>
        
        
        <div id="confirm-settlement-dialog" 
            class="mdc-dialog"
            role="alertdialog"
            aria-modal="true"
            aria-labelledby="my-dialog-title"
            aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">

                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->Confirm Settlement<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                        Do you accept this settlement?
                    </div>
                    <div class="mdc-text-field mdc-text-field--full-width">
                        <input type="text"
                               id="thread-id"
                               value="{{threadId}}"
                               disabled
                               class="mdc-text-field__input">
                        <label class="mdc-floating-label" for="thread-id">
                            ThreadId
                        </label>
                    </div>
                  
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button type="button" 
                                id="confirm-settlement-send"
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
                        >
                            <span class="mdc-button__label">Confirm</span>
                        </button>
                    </footer>
                </div>
            </div>
        </div><div class="mdc-dialog-scrim"></div>
        
        <div id="settle-now-dialog" 
           
            class="mdc-dialog"
             role="alertdialog"
             aria-modal="true"
             aria-labelledby="my-dialog-title"
             aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">
                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->Create Settlement Request<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                        <p class="warning" style="color:red; visibility: hidden">
                            You can not settle this amount because you are a net receiver.
                        </p>
                        
                        <div style="display:fex; flex-direction: column">
                            <form id="new-credit-dialog-form">
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" disabled id="settle-now-thread-ids"
                                           value="{{threadIds}}"
                                           required
                                           class="mdc-text-field__input ">
                                    <label class="mdc-floating-label" for="settle-now-thread-ids">
                                        ThreadIds
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" disabled id="settle-now-payer"
                                           value="{{settleNowPayer}}"
                                           required
                                           class="mdc-text-field__input ">
                                    <label class="mdc-floating-label" for="settle-now-payer">
                                        Payer 
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" disabled id="settle-now-recipient"
                                           value="{{settleNowRecipient}}"
                                           required
                                           class="mdc-text-field__input ">
                                    <label class="mdc-floating-label" for="settle-now-recipient">
                                        Recipient 
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text" disabled id="settle-now-net-value"
                                           value="{{netValue}}"
                                           required
                                           class="mdc-text-field__input ">
                                    <label class="mdc-floating-label" for="settle-now-net-value">
                                        Net Value 
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text"
                                           id="settle-now-additional-notes"
                                           required minlength=4
                                           id="my-text-field" class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="settle-now-additional-notes">
                                        Additional Notes
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field-helper-line">
                                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">
                                        Field is required and must be at least 4 characters long
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button id="settle-now-send" type="button" 
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
                        >
                            <span class="mdc-button__label">Send Now</span>
                        </button>
                    </footer>
                </div>

            </div>
        </div><div class="mdc-dialog-scrim"></div>
        
        <div id="select-paychannel-dialog" 
           
            class="mdc-dialog"
             role="alertdialog"
             aria-modal="true"
             aria-labelledby="my-dialog-title"
             aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">
                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->Select a payment channel<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                       <br/>
                        
                        <div style="display:fex; flex-direction: column">
                            
                            <form id="select-paychannel-dialog-form">
                                <div class="mdc-select">
                                    <div class="mdc-select__anchor " style="width: 100%;">
                                      <i class="mdc-select__dropdown-icon"></i>
                                      <div class="mdc-select__selected-text"></div>
                                      <span class="mdc-floating-label">Select channel</span>
                                      <div class="mdc-line-ripple"></div>
                                    </div>

                                    <div class="mdc-select__menu mdc-menu mdc-menu-surface" style="width: 100%;">
                                        <template id="mdc-list-item-template">
                                                <li class="mdc-list-item" data-value="Diana">
                                                  Diana
                                                </li>
                                        </template>  
                                        <ul id="channel-name" class="mdc-list" data-value="Diana">

                                        </ul>
                                    </div>
                                 </div>
                
                                <br/>
                                <div class="mdc-text-field mdc-text-field--full-width">
                                    <input type="text"
                                           id="channel-additional-notes"
                                           required minlength=4
                                           id="my-text-field" class="mdc-text-field__input">
                                    <label class="mdc-floating-label" for="settle-now-additional-notes">
                                        Additional Notes
                                    </label>
                                </div>
                                
                                <div class="mdc-text-field-helper-line">
                                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">
                                        Field is required and must be at least 4 characters long
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button id="channel-now-send" type="button" 
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
                        >
                            <span class="mdc-button__label">Send Now</span>
                        </button>
                    </footer>
                </div>

            </div>
        </div><div class="mdc-dialog-scrim"></div>
        
        <div id="confirm-pay-channel-dialog" 
            class="mdc-dialog"
            role="alertdialog"
            aria-modal="true"
            aria-labelledby="my-dialog-title"
            aria-describedby="my-dialog-content">
            <div class="mdc-dialog__container">

                <div class="mdc-dialog__surface" >
                    <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                    <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
                    -->Confirm Payment Channel<!--
                    --></h2>
                    <div class="mdc-dialog__content" id="my-dialog-content" >
                       Accept this payment channel
                    </div>
                    <div class="mdc-text-field mdc-text-field--full-width">
                        <input type="text"
                               id="channel-name"
                               value="{{paychannel}}"
                               disabled
                               class="mdc-text-field__input">
                        <label class="mdc-floating-label" for="thread-id">
                            Proposed payment channel
                        </label>
                    </div>
                  
                    <footer class="mdc-dialog__actions" style="padding:24px">
                        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                            <span class="mdc-button__label">Cancel</span>
                        </button>
                        <button type="button" 
                                id="confirm-channel-send"
                                class="mdc-button mdc-button--raised  mdc-dialog__button" 
                        >
                            <span class="mdc-button__label">Confirm</span>
                        </button>
                    </footer>
                </div>
            </div>
        </div><div class="mdc-dialog-scrim"></div>
        
      
        <div id="snackbar" class="mdc-snackbar">
                <div class="mdc-snackbar__surface">
                    <div class="mdc-snackbar__label"
                        role="status"
                        aria-live="polite">
                       
                    </div>
                    <div class="mdc-snackbar__actions">
                        <button type="button" class="mdc-button mdc-snackbar__action">Ok</button>
                    </div>
                </div>
        </div>
       
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
      
        
        <script>
            thisuserName = "";
            buyerSellers = [];
            paymentChannels = [];
            
            document.addEventListener("DOMContentLoaded", init);
            
            async function init ()  {
                //location.hash ='';
                let responseWhoami =  await fetch('addressbook/me/');
                let whoami = await responseWhoami.json();
                thisuserName =  whoami.name;
                
                document.getElementById("this-user").innerHTML=whoami.name;
                document.getElementById("this-pk").innerHTML=whoami.publicKey;
                document.getElementById("this-pk").title=whoami.publicKey;
                
                responsePaymentChannel = await fetch('addressbook/paychannel/');
                paymentChannels  = await responsePaymentChannel.json(); 
                
                
                let responseAddressBook = await fetch('addressbook/buyerseller/');
                let addressBook  = await responseAddressBook.json(); 
                buyerSellers = addressBook;
                switch(location.hash){
                    case "#audit-detail": 
                        location.hash="audit";
                        ;
                        break;
                    default: //event.preventDefault();//do nothing'
                }
                renderMain();
                window.onhashchange = renderMain;
                
                async function renderMain(){
                    document.getElementById("main-panel-holder").innerHTML = "";
                    switch(location.hash){
                        case '#credits-and-debits':
                            document.title= thisuserName + ' - Credits and Debits';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .credits-and-debits").classList.add("mdc-list-item--activated");
                            document.getElementById("header-title").innerHTML = 'Outstanding Credits and Debits';
                            for(i=0; i < addressBook.length; i++){
                                var userName = addressBook[i].name;
                                await renderCreditsPanel(userName);
                            }
                            break;
                        case '#settlements':
                            document.title= thisuserName + ' - Settlements';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .settlements").classList.add("mdc-list-item--activated");
                            
                            document.getElementById("header-title").innerHTML = 'Settlements';
                            for(i=0; i < addressBook.length; i++){
                                var userName = addressBook[i].name;
                                await renderSettlementsPanel(userName);
                            }
                            break;
                        case '#audit':
                            document.title=thisuserName + ' - Audit';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .audit").classList.add("mdc-list-item--activated");
                            document.getElementById("header-title").innerHTML = 'Audit';
                            renderAuditIndexTable();
                            break;
                        case '#audit-detail':break;
                        default://
                    }
                    styleButtons();
                }
                
                
            };
            
       </script>
       <script>
            async function renderAuditIndexTable(){
                var panelTemplate = document.getElementById("audit-table-template");
                var clonedTableTemplate = panelTemplate.content.cloneNode(true);
                
                let responseThreadIds = await fetch('audit/');
                let threadIdsJson = await  responseThreadIds.json();
                var tableBodyTemplate = clonedTableTemplate.getElementById("audit-table-body-template");
                
                var tableBody = clonedTableTemplate.getElementById("audit-table-body");
                threadIdsJson.threadIds.forEach(
                    t=>{
                        clonedRow = tableBodyTemplate.content.cloneNode(true);
                        tr = clonedRow.querySelector("tr");
                        tr.cells.threadId.textContent=formatThreadId(t.threadId);
                        tr.cells.context.textContent=t.context;
                        tr.cells.status.textContent=t.status;
                        tr.cells.topicId.textContent=t.topicId;
                        tr.cells.createdDate.textContent=t.createdDate;
                        tr.cells.createdTime.textContent=t.createdTime;
                        tr.querySelector("#audit-table-row-expand").onclick=function(){
                            openAuditThread(t.threadId);
                        };
                        tableBody.appendChild(tr);
                    }
                );
                document.getElementById("main-panel-holder").appendChild(clonedTableTemplate);
            }
            
            async function openAuditThread(threadId){
                
                event.preventDefault();
                
                main = document.getElementById('main-panel-holder');
                main.innerHTML="";
                document.getElementById('header-title').innerHTML = "<a href='#audit' class='mdc-button'><i style='font-size:26px;' class='material-icons'>arrow_back</i></a> <span style='position:relative;top:2px'>Audit Thread ID: " + threadId + " Details</span>";
                location.hash='audit-detail';
                //$auditThreadDialog =  document.getElementById('audit-thread-dialog');
                
                //auditThreadDialog  = new mdc.dialog.MDCDialog($auditThreadDialog);
                //$auditThreadDialog.querySelector("#thread-id").innerHTML = threadId;
                
                let response = await fetch('audit/'+threadId);
                let responseJSON = await  response.json();
                //$auditThreadDialog.querySelector("#audit-thread-panel-holder").innerHTML="";
                responseJSON.auditApplicationMessages.forEach(async m=>{
                    let response = await fetch('audit/'+threadId+"/"+m.applicationMessageId);
                    let responseJSON = await  response.json();
                    responseJSON = responseJSON.auditHCSMessages;
                    clonedTemplate = document.getElementById("audit-thread-template").content.cloneNode(true);
                    clonedTemplate.querySelector("#audit-thread-message-id").innerHTML=m.applicationMessageId;
                    clonedTemplate.querySelector("#audit-thread-message-text").innerHTML=syntaxHighlight(m.message);//.substring(0,180)+"...";
                    clonedTemplate.querySelector("#audit-thread-message-parts-json").innerHTML=syntaxHighlight(responseJSON);
                    main.appendChild(clonedTemplate);
                });
        
                //auditThreadDialog.open();
                return false;
            }
            
            function syntaxHighlight(json) {
                
                if (typeof json != 'string') {
                     json = JSON.stringify(json, undefined, 2);
                }
               
                json = json.replace(/([^ -~-\n]+)/g, "Ħ");
                json = json.replace(/\\n/g, '\n\t\t');
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }
            
        </script>
        
        
        <script>
            async function  renderSettlementsPanel(userName){
                //if (document.getElementById(userName) === null) {
                var panelTemplate = document.getElementById("settlements-panel");
                var clonedPanelTemplate = panelTemplate.content.cloneNode(true);
                clonedPanelTemplate.querySelector(".panel").id=userName;    
                clonedPanelTemplate.getElementById("settlements-user").innerHTML = userName;
                
              


                var tableBody = clonedPanelTemplate.getElementById("settlement-table-body");
                var tableBodyTemplate = clonedPanelTemplate.getElementById("settlement-table-body-template");

                var responseSettlements = await fetch(`settlements/${userName}`);
                var responseSettlementsL = await responseSettlements.json();
                
                for(z=0; z < responseSettlementsL.length ; z++){
                    i_Settlements = responseSettlementsL[z];
                    clonedRow = tableBodyTemplate.content.cloneNode(true);
                    clonedRow.getElementById("row-role").innerHTML = "<b>Settlement "+((z*1)+1)+"</b>"; 
                    
                    threadId = i_Settlements.threadId;
                    clonedRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                    clonedRow.getElementById("threadId").title = threadId;
                    clonedRow.getElementById("threadId").setAttribute("data-thread-id", threadId );

                    clonedRow.getElementById("recipient").innerHTML = i_Settlements.recipientName;
                    clonedRow.getElementById("payer").innerHTML = i_Settlements.payerName;
                    clonedRow.getElementById("reference").innerHTML = "";
                    
                    clonedRow.getElementById("amount-net").innerHTML = "Net " + i_Settlements.netValue;
                
                    clonedRow.getElementById("date-time").innerHTML = i_Settlements.createdDateTime;
                    clonedRow.getElementById("status").innerHTML =  i_Settlements.displayStatus + (i_Settlements.paymentChannelName===null?"":" (with "+ i_Settlements.paymentChannelName +")");
                    //clonedRow.getElementById("status").style.textTransform = "capitalize";
                    
                    
                    
                    if(i_Settlements.payerName === userName &&  i_Settlements.status === 'SETTLEMENT_PROPOSED'){ //SETTLEMENT_PROPOSED
                        let threadId = i_Settlements.threadId;
                        newButton = document.createElement("button");
                        newButton.innerHTML = "Accept";
                        newButton.classList.add("mdc-button");
                        newButton.classList.add("mdc-button--outlined");
                        newButton.addEventListener("click", function(){openConfirmSettlementDialog(threadId,userName);});
                        clonedRow.getElementById("action").appendChild(newButton);
                    } else if (i_Settlements.payerName === thisuserName  &&  i_Settlements.status === 'SETTLEMENT_AGREED'){
                        let threadId = i_Settlements.threadId;
                        newButton = document.createElement("button");
                        newButton.innerHTML = "Prop Paychannel";
                        newButton.classList.add("mdc-button");
                        newButton.classList.add("mdc-button--outlined");
                        newButton.addEventListener("click", function(){openSelectPaychannelDialog(threadId,userName);});
                        clonedRow.getElementById("action").appendChild(newButton);
                    } else if (i_Settlements.payerName === userName  &&  i_Settlements.status === 'SETTLE_INIT_AWAIT_ACK'){
                        let threadId = i_Settlements.threadId;
                        newButton = document.createElement("button");
                        newButton.innerHTML = "Accept";
                        newButton.classList.add("mdc-button");
                        newButton.classList.add("mdc-button--outlined");
                        newButton.addEventListener("click", function(){openAcceptPaychannelDialog(threadId,userName,i_Settlements.paymentChannelName );});
                        clonedRow.getElementById("action").appendChild(newButton);
                    }
                  
                    clonedRow.getElementById("notes").innerHTML = i_Settlements.additionalNotes;
                    tableBody.appendChild(clonedRow);
                    for(c in i_Settlements.credits){
                        credit = i_Settlements.credits[c];
                        clonedCreditRow = tableBodyTemplate.content.cloneNode(true);
                        clonedCreditRow.querySelector("tr").style.backgroundColor="#fafafa";
                        clonedCreditRow.querySelector("tr").style.border=0;
                        clonedCreditRow.getElementById("row-role").innerHTML = "Credit " + (c*1+1); 
                        
                        threadId = credit.threadId;
                        clonedCreditRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                        clonedCreditRow.getElementById("threadId").title = threadId;
                        clonedCreditRow.getElementById("threadId").setAttribute("data-thread-id", threadId );

                        clonedCreditRow.getElementById("recipient").innerHTML = credit.recipientName;
                        clonedCreditRow.getElementById("payer").innerHTML = credit.payerName;
                        clonedCreditRow.getElementById("reference").innerHTML = credit.reference;
                        clonedCreditRow.getElementById("amount-net").innerHTML = credit.amount;
                        clonedCreditRow.getElementById("notes").innerHTML = credit.additionalNotes;
                        
                        clonedCreditRow.getElementById("date-time").innerHTML = credit.createdDateTime;
                        clonedCreditRow.getElementById("status").innerHTML =  credit.displayStatus;
                        //clonedCreditRow.getElementById("net-value").innerHTML = "";


                    
                        tableBody.appendChild(clonedCreditRow);
                    }
                    
                }     
                if (document.getElementById(userName) === null) { // check if panel exists
                    document.getElementById("main-panel-holder").appendChild(clonedPanelTemplate);
                } else {
                    existingPanel = document.getElementById(userName);
                    clonedPanelTemplate.querySelector("details").setAttribute("open","true");
                    existingPanel.replaceWith(clonedPanelTemplate);
                }

            }
        </script>
        
        
        
        <script>
            async function  renderCreditsPanel(userName){
                //if (document.getElementById(userName) === null) {
                var panelTemplate = document.getElementById("credits-and-debits-panel");
                var clonedPanelTemplate = panelTemplate.content.cloneNode(true);
                clonedPanelTemplate.querySelector(".panel").id=userName;    
                clonedPanelTemplate.getElementById("credits-and-debits-user").innerHTML = userName;
                
                let userNameP = userName; {
                    clonedPanelTemplate.getElementById("new-credit-button").addEventListener("click",
                        function(){
                            openNewCreditDialog(userNameP);
                        }
                    );
                    clonedPanelTemplate.getElementById("settle-now-button").addEventListener("click",
                        function(){
                           openSettleNowDialog(userNameP);
                        }
                    );
                }


                var tableBody = clonedPanelTemplate.getElementById("credit-table-body");
                var tableBodyTemplate = clonedPanelTemplate.getElementById("credit-table-body-template");

                var responseCredits = await fetch(`credits/${userName}`);
                var i_UserCredits = await responseCredits.json();
                
                for(z=0; z < i_UserCredits.length ; z++){
                    clonedRow = tableBodyTemplate.content.cloneNode(true);
                    if(i_UserCredits[z].status === 'CREDIT_AGREED' ){
                        clonedPanelTemplate.getElementById("settle-now-button").removeAttribute("disabled");
                        clonedRow.getElementById("settle-check").style.visibility="visible";
                        clonedRow.getElementById("checkbox-1").checked="true";
                    }
                    threadId = i_UserCredits[z].threadId;
                    clonedRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                    clonedRow.getElementById("threadId").title = threadId;
                    clonedRow.getElementById("threadId").setAttribute("data-thread-id", threadId );

                    clonedRow.getElementById("recipient").innerHTML = i_UserCredits[z].recipientName;
                    clonedRow.getElementById("payer").innerHTML = i_UserCredits[z].payerName;
                    clonedRow.getElementById("reference").innerHTML = i_UserCredits[z].reference;
                    clonedRow.getElementById("amount").innerHTML = i_UserCredits[z].currency + ' '+ i_UserCredits[z].amount;
                    clonedRow.getElementById("amount").setAttribute("data-amount", i_UserCredits[z].amount );
                    clonedRow.getElementById("amount").setAttribute("data-currency", i_UserCredits[z].currency );


                    clonedRow.getElementById("date-time").innerHTML = i_UserCredits[z].createdDateTime;
                    clonedRow.getElementById("status").innerHTML =  i_UserCredits[z].displayStatus;
                    //clonedRow.getElementById("status").innerHTML =  i_UserCredits[z].status.toLowerCase().replace(/_/g," ");
                    //clonedRow.getElementById("status").style.textTransform = "capitalize";

                    if(i_UserCredits[z].payerName === userName &&  i_UserCredits[z].status === 'CREDIT_PROPOSED'){
                      let threadId = i_UserCredits[z].threadId;
                      newButton = document.createElement("button");
                      newButton.innerHTML = "Accept";
                      newButton.classList.add("mdc-button");
                      newButton.classList.add("mdc-button--outlined");
                      newButton.addEventListener("click", function(){openConfirmCreditDialog(threadId,userName);});
                      clonedRow.getElementById("action").appendChild(newButton);
                    } 
                  
                    clonedRow.getElementById("notes").innerHTML = i_UserCredits[z].additionalNotes;
                    tableBody.appendChild(clonedRow);
                }     
                if (document.getElementById(userName) === null) { // check if panel exists
                    document.getElementById("main-panel-holder").appendChild(clonedPanelTemplate);
                } else {
                    existingPanel = document.getElementById(userName);
                    clonedPanelTemplate.querySelector("details").setAttribute("open","true");
                    existingPanel.replaceWith(clonedPanelTemplate);
                }

            }
            
            
            function openNewCreditDialog(recipient) {
                
                /* Functions for the new credit dialog. () */
                newCreditDialog  = new mdc.dialog.MDCDialog(document.getElementById('new-credit-dialog'));
                
                
                event.preventDefault();
                
                $newCreditDialog = document.getElementById('new-credit-dialog');
                /*Clear styles and values to reuse fields*/
                $newCreditDialog.querySelectorAll(".mdc-text-field input").forEach(function(e){
                    e.parentElement.classList.remove('mdc-text-field--invalid');
                    e.value='';}
                );
                 
                $newCreditDialog.querySelector("#new-credit-recipient").value = recipient;
                
                $newCreditDialog.querySelector("#send-new-credit-dialog-submit").onclick =  function(){
                        $newCreditDialog = document.getElementById('new-credit-dialog');
                        /* validate form */
                        isFormValid = true;
                        ls = $newCreditDialog.querySelectorAll(".mdc-text-field input");

                        for (i=0; i< ls.length; i++ ){
                             if (! ls[i].checkValidity()){ls[i].focus();isFormValid=false;break;  }

                        }
                        if(isFormValid){
                            postBody = `{
                                          "payerName"       : "${thisuserName}"
                                        , "recipientName"   : "${document.getElementById('new-credit-recipient').value}"  
                                        , "reference"       : "${document.getElementById('new-credit-service-reference').value}"
                                        , "amount"          : ${document.getElementById('new-credit-amount').value * 1}
                                        , "currency"        : "USD"
                                        , "additionalNotes" :"${document.getElementById('new-credit-additional-notes').value}"
                                        }`;

                            newCreditDialog.close();
                            el = document.getElementById(recipient);
                            el.style.opacity=0.4;
                            el.style.pointerEvents =  'none';
                            el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                            showSnackBarMessage("sending new credit to HH Network ...");
                            fetch('credits', {
                                method: 'post',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: postBody
                            }).then(function(response) {
                                return response.json();
                            }).then(function(data) {
                                showSnackBarMessage("New credit request sent");

                            }).catch(function(res){
                                alert(res);
                            });
                        }      
                    
                };
               
                newCreditDialog.open();
                return false;
            }
            
           
            function openSelectPaychannelDialog(threadId, userName) {
                $paychannelDialog = document.getElementById('select-paychannel-dialog');
                paychannelDialog  = new mdc.dialog.MDCDialog($paychannelDialog);
                
                
                event.preventDefault(); 
                
          
              
                $paychannelDialog.querySelectorAll(".mdc-text-field input").forEach(function(e){
                    e.parentElement.classList.remove('mdc-text-field--invalid');
                    e.value='';}
                );
                const mdcSelect  =  new mdc.select.MDCSelect( $paychannelDialog.querySelector(".mdc-select"));
                mdcList =  $paychannelDialog.querySelector(".mdc-list");
                paymentChannels.forEach(c => {
                    clonedListItem = $paychannelDialog.querySelector("#mdc-list-item-template").content.cloneNode(true);
                    clonedListItem.querySelector("li").innerHTML=c.name;
                    clonedListItem.querySelector("li").setAttribute("data-value",c.name);
                    mdcList.appendChild(clonedListItem);
                });
                selectedPaymentChannelName=paymentChannels[0];
                mdcSelect.listen('MDCSelect:change', () => {
                    selectedPaymentChannelName = mdcSelect.value;
                  });
                $paychannelDialog.querySelector("#channel-now-send").onclick =  function(){
                
                    postBody = `{
                                 "threadId"          : "${threadId}"
                                , "paymentChannelName" :"${selectedPaymentChannelName}"
                                , "additionalNotes" :"${$paychannelDialog.querySelector('#channel-additional-notes').value}"
                                }`;

                    paychannelDialog.close();
                    el = document.getElementById(userName);
                    el.style.opacity=0.4;
                    el.style.pointerEvents =  'none';
                    el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                    showSnackBarMessage("sending channel details to HH Network ...");
                    fetch('/settlements/proposechannel', {
                        method: 'post',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: postBody
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        showSnackBarMessage("New channel proposal sent");

                    }).catch(function(res){
                        alert(res);
                    });
                }
                
                /*
                $newCreditDialog.querySelector("#send-new-credit-dialog-submit").onclick =  function(){
                        $newCreditDialog = document.getElementById('new-credit-dialog');
                 
                        isFormValid = true;
                        ls = $newCreditDialog.querySelectorAll(".mdc-text-field input");

                        for (i=0; i< ls.length; i++ ){
                             if (! ls[i].checkValidity()){ls[i].focus();isFormValid=false;break;  }

                        }
                        if(isFormValid){
                            postBody = `{
                                          "payerName"       : "${thisuserName}"
                                        , "recipientName"   : "${document.getElementById('new-credit-recipient').value}"  
                                        , "reference"       : "${document.getElementById('new-credit-service-reference').value}"
                                        , "amount"          : ${document.getElementById('new-credit-amount').value * 1}
                                        , "currency"        : "USD"
                                        , "additionalNotes" :"${document.getElementById('new-credit-additional-notes').value}"
                                        }`;

                            newCreditDialog.close();
                            el = document.getElementById(recipient);
                            el.style.opacity=0.4;
                            el.style.pointerEvents =  'none';
                            el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                            showSnackBarMessage("sending new credit to HH Network ...");
                            fetch('credits', {
                                method: 'post',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: postBody
                            }).then(function(response) {
                                return response.json();
                            }).then(function(data) {
                                showSnackBarMessage("New credit request sent");

                            }).catch(function(res){
                                alert(res);
                            });
                        }      
                    
                };
                */
               
                paychannelDialog.open();
                return false;
            }
            
        
            function openAcceptPaychannelDialog (threadId, otherUserId,channelName){
                event.preventDefault();
                confirmChannelDialog  = new mdc.dialog.MDCDialog(document.getElementById('confirm-pay-channel-dialog'));

                $confirmChannelDialog = document.getElementById('confirm-pay-channel-dialog');
                $confirmChannelDialog.querySelector("#channel-name").value=channelName;
                clickFunction = function(){
                   
                    showSnackBarMessage("sending confirmation " + threadId + " ...");
                    confirmChannelDialog.close();

                    el = document.getElementById(otherUserId);
                    el.style.opacity=0.4;
                    el.style.pointerEvents =  'none';
                    el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                    fetch('settlements/proposechannel/ack/'+threadId, {
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            showSnackBarMessage("confirmation sent");

                        }).catch(function(res){
                            alert(res);
                        });
        
                };
                $confirmChannelDialog.querySelector("#confirm-channel-send").onclick = clickFunction;
                confirmChannelDialog.open();
                return false;
        
            }
        
            
            function openConfirmCreditDialog(threadId,otherUserId) {
                event.preventDefault();
                confirmCreditDialog  = new mdc.dialog.MDCDialog(document.getElementById('confirm-credit-dialog'));

                $confirmCreditDialog = document.getElementById('confirm-credit-dialog');
                $confirmCreditDialog.querySelector("#thread-id").value=threadId;
                clickFunction = function(){
                    $confirmCreditDialog = document.getElementById('confirm-credit-dialog');
                    threadId = $confirmCreditDialog.querySelector("#thread-id").value;
                    showSnackBarMessage("sending confirmation " + threadId + " ...");
                    confirmCreditDialog.close();

                    el = document.getElementById(otherUserId);
                    el.style.opacity=0.4;
                    el.style.pointerEvents =  'none';
                    el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                    fetch('credits/ack/'+threadId, {
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            showSnackBarMessage("confirmation sent");

                        }).catch(function(res){
                            alert(res);
                        });
        
                };
                $confirmCreditDialog.querySelector("#confirm-credit-send").onclick = clickFunction;
                confirmCreditDialog.open();
                return false;
            }
            
            function openConfirmSettlementDialog(threadId,otherUserId) {
                event.preventDefault();
                confirmSettlementDialog  = new mdc.dialog.MDCDialog(document.getElementById('confirm-settlement-dialog'));

                $confirmSettlementDialog = document.getElementById('confirm-settlement-dialog');
                $confirmSettlementDialog.querySelector("#thread-id").value=threadId;
                clickFunction = function(){
                    $confirmSettlementDialog = document.getElementById('confirm-settlement-dialog');
                    threadId = $confirmSettlementDialog.querySelector("#thread-id").value;
                    showSnackBarMessage("sending confirmation " + threadId + " ...");
                    confirmSettlementDialog.close();

                    el = document.getElementById(otherUserId);
                    el.style.opacity=0.4;
                    el.style.pointerEvents =  'none';
                    el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');

                    fetch('settlements/ack/'+threadId, {
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            showSnackBarMessage("confirmation sent");

                        }).catch(function(res){
                            alert(res);
                        });
        
                };
                $confirmSettlementDialog.querySelector("#confirm-settlement-send").onclick = clickFunction;
                confirmSettlementDialog.open();
                return false;
            }
        </script>
            
        <script>
            
            function openSettleNowDialog(otherUserId){
                /* Functions for settlement dialog in credit tab */
                settleNowDialog  = new mdc.dialog.MDCDialog(document.getElementById('settle-now-dialog'));
                event.preventDefault();
                $settleNowDialog = document.getElementById('settle-now-dialog');
                
                $settleNowDialog.querySelector("#settle-now-additional-notes").removeAttribute("disabled");
                $settleNowDialog.querySelector("#settle-now-send").removeAttribute("disabled");
                $settleNowDialog.querySelector(".warning").style.visibility='hidden';
                /*
                 * Calculate the net amount.
                 */
                
                var thisUserPays = 0;
                var otherUserPays = 0;
                var payerName = "";
                var recipientName = "";
                var threadIds=[];    
                document.querySelectorAll("#"+otherUserId+" .mdc-data-table__row").forEach(
                    r=>{
                         if(r.cells.settlebox.querySelector("input").checked){
                             threadIds.push(r.cells.threadId.title);
                             rowAmount = 1*r.cells.amount.getAttribute("data-amount");
                             if (r.cells.payer.textContent!==otherUserId){
                                thisUserPays += rowAmount ;
                            } else {
                                otherUserPays += rowAmount ; 
                            }
                         }
                     }
                );
                
                payerName = thisUserPays > otherUserPays? thisuserName : otherUserId;
                recipientName = thisUserPays < otherUserPays? thisuserName : otherUserId;
                netValue = Math.abs(thisUserPays - otherUserPays);
                
              
                $settleNowDialog.querySelector("#settle-now-thread-ids").value=threadIds;
                $settleNowDialog.querySelector("#settle-now-payer").value= payerName;
                $settleNowDialog.querySelector("#settle-now-dialog #settle-now-recipient").value= recipientName;
                $settleNowDialog.querySelector("#settle-now-dialog #settle-now-net-value").value= netValue;
                
                clickFunction = function(){
                    additionalNotes = $settleNowDialog.querySelector("#settle-now-additional-notes").value;
                    //alert(thisUserPays + " " + otherUserPays);
                    settleNowDialog.close();
                    
                    el = document.getElementById(otherUserId);
                    el.style.opacity=0.4;
                    el.style.pointerEvents =  'none';
                    el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');
                    
                    postBody = `{
                                  "payerName"       : "${payerName}"
                                , "recipientName"   : "${recipientName}"  
                                , "netValue"        : ${netValue}
                                , "currency"        : "USD"
                                , "threadIds"       : ${JSON.stringify(threadIds)}
                                , "additionalNotes" : "${additionalNotes}"
                                }`;
                    
              
                    showSnackBarMessage("sending new settlement request to HH Network ...");
                    fetch('settlements', {
                        method: 'post',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: postBody
                    }).then(function(response) {
                        if (response.status===200){
                            showSnackBarMessage("Settlement request sent");
                        } else {
                            alert("Failed to send message to HH network");
                        }
                    }).catch(function(res){
                        alert(res);
                    });
                    
                    
                };
                if (payerName === thisuserName) {
                    $settleNowDialog.querySelector("#settle-now-send").onclick =  clickFunction;
                }   else {
                    $settleNowDialog.querySelector("#settle-now-additional-notes").setAttribute("disabled","disabled");
                    $settleNowDialog.querySelector("#settle-now-send").setAttribute("disabled","disabled");
                    $settleNowDialog.querySelector(".warning").style.visibility='visible';
                }
                
                settleNowDialog.open();
                return false;
            }
            
        </script>
        
        
        <script>
            /* Visual effects for components. This script does not apply an client long. */
           
            leftDrawer = mdc.drawer.MDCDrawer.attachTo(document.getElementById('left-drawer'));
            leftDrawer.open = true;
            //list = mdc.list.MDCList.attachTo(document.querySelector('.mdc-list'));

            topAppBar = mdc.topAppBar.MDCTopAppBar.attachTo(document.getElementById('app-bar'));
            topAppBar.setScrollTarget(document.getElementById('main-content'));
            topAppBar.listen('MDCTopAppBar:nav', () => {
                leftDrawer.open = !leftDrawer.open;
            });
            
           
            styleButtons();
            styleTextFields();
            styleTextFieldIcons();
       

            function styleButtons(){
                buttons = document.querySelectorAll('.mdc-button');
                for (i = 0; i < buttons.length; i++) {
                    buttons[i].innerHTML = "<span class='mdc-button__ripple'></span>" + buttons[i].innerHTML;
                    d_button = new mdc.ripple.MDCRipple(buttons[i]);
                }
            }

            function styleTextFields(){
                textFields = document.querySelectorAll('.mdc-text-field');
                for (i = 0; i < textFields.length; i++) {
                    //textFields[i].insertAdjacentHTML("afterend",'<div class="mdc-text-field-helper-line"><div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">helpme</div></div>');
                    textFields[i].innerHTML = "<span class='mdc-line-ripple'></span>" + textFields[i].innerHTML;
                    d_textFieldHelperText = new mdc.textField.MDCTextFieldHelperText(textFields[i].parentElement.querySelector('.mdc-text-field-helper-text'));
                    d_textField = new mdc.textField.MDCTextField(textFields[i]);
                }
            }
            
            function styleTextFieldIcons(){
                textFieldIcons = document.querySelectorAll('.mdc-text-field-icon');
                for (i = 0; i < textFieldIcons.length; i++) {
                    d_textFieldIcon = new mdc.textFieldIcon.MDCTextFieldIcon(textFieldIcons[i]);
                }
            }
    
            function styleDataTables(){
                dataTables = document.querySelector('.mdc-data-table');
                for (i = 0; i < dataTables.length; i++) {
                    d_textFieldIcon = new mdc.textFieldIcon.MDCTextFieldIcon(textFieldIcons[i]);
                    d_dataTable = new mdc.dataTable.MDCDataTable(dataTables[i]);
                }
            }
            
        </script>
        
        <script>
            var socket = new SockJS('/notifications');
                stompClient = Stomp.over(socket);  
                stompClient.debug = null;
                stompClient.connect({}, function(frame) {
                  
                    //console.log('Connected: ' + frame);
                    stompClient.subscribe('/notifications/messages', function(messageOutput) {
                        onStompMessage(JSON.parse(messageOutput.body));
                    });
            });
            
            async function onStompMessage(messageOutput) {
                notifyUi = messageOutput.context;
                switch (notifyUi) {
                    case "credits":  
                        if(location.hash === '#settlements'){
                            await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                   );
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable()(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        }
                        
                        break;
                    case "settlements":
                        if(location.hash === '#settlements'){
                            await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                   );
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable()(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        }
                        break;
                    case "audits":
                        if(location.hash === '#settlements'){
                            await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                   );
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable()(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        }
                        break;
                    default: alert("wrong target element");
                }
                document.getElementById("notification-badge").innerHTML = document.getElementById("notification-badge").innerHTML * 1.0 + 1;
                document.getElementById("notification-badge").style.display="block";
             }
             
            function showSnackBarMessage(message){
                snackbarEl = document.getElementById("snackbar");
                snackbar = new mdc.snackbar.MDCSnackbar(snackbarEl);
                snackbar.labelText = message;
                snackbar.timeoutMs = 5000;
                snackbar.open();
            
            }
            
            async function recreateData(){
                restore = confirm("This will delete your data and restore test data");
                if( restore){
                        await fetch('admin/deletedata');
                        //await fetch('admin/createtestdata');
                        await location.reload();
                }
            }
            
            function formatThreadId(threadId){
                 return   threadId.substring(0,2) + "..." + threadId.substring(threadId.length - 4,threadId.length);
            }
            
        </script>
    </body>
</html>