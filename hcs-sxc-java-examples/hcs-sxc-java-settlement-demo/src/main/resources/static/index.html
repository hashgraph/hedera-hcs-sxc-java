<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
        <meta name="theme-color" content="#000000">

        <!-- Required styles for MDC Web -->
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="styles/custom.css"/>
      
        <script>
            /*
             * Function to include external html files. 
             * The UI implements a number of modal popups which
             * are imported on page load.
             */
            function includeHTML() {
                var z, i, elmnt, file, xhttp;
                z = document.getElementsByTagName("*");
                for (i = 0; i < z.length; i++) {
                    elmnt = z[i];
                    file = elmnt.getAttribute("hh-include-html");
                  if (file) {
                    xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState === 4) {
                            if (this.status === 200) {
                                elmnt.innerHTML = this.responseText;
                            }
                            if (this.status === 404) {
                                elmnt.innerHTML = "Page not found.";
                            }
                            elmnt.removeAttribute("hh-include-html");
                                includeHTML();
                            }
                        };
                        xhttp.open("GET", file, true);
                        xhttp.send();
                        return;
                    }
                }
            }
        </script> 
    </head>
    <body>
        <header class="mdc-top-app-bar app-bar mdc-top-app-bar--fixed" id="app-bar">     
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <button href="#" class="demo-menu   mdc-icon-button material-icons  mdc-top-app-bar__navigation-icon">menu</button>
                    <span class="mdc-top-app-bar__title">HCS - Settlement Demo</span>
                </section>
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
                    <div style="position:relative">
                        <button class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Alert">notifications</button>
                        <div id="notification-badge" 
                            style=" 
                             display:none;
                             width:20px;
                             height:20px;
                             line-height: 20px;
                             text-align: center;
                             font-size: 10px;
                             font-weight: bold;
                             font-family: Roboto;
                             border-radius: 50%;
                             position:absolute; 
                             background-color: red;
                             top:5px;
                             right:5px;
                             ">
                            0
                        </div>
                    </div>
                    <button
                        onclick="saveData()"
                        class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Save Database">save</button>
                    <button 
                        onclick="restoreData()"
                        class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Restore Database">restore</button>
                  
                    <button 
                        onclick="recreateData()"
                        class="mdc-icon-button material-icons mdc-top-app-bar__action-item--unbounded" aria-label="Recreate all date">delete_sweep</button>
                </section>
            </div>           
        </header>

        <aside id="left-drawer" class="mdc-drawer mdc-drawer--dismissible   mdc-top-app-bar--fixed-adjust">
            <div class="mdc-drawer__content">
                <header class="mdc-top-app-bar  mdc-top-app-bar--fixed mdc-theme--primary
                        " 
                        style="background-color: #fafafa;
                        border-bottom: 1px solid rgba(0,0,0,.12);
                        "
                        id="app-bar-of-main-content">     
                    <div class="mdc-top-app-bar__row">
                        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                            
                            <span class="mdc-typography--headline6" 
                                              id="this-user-avatar"
                                              style="width:36px; height:36px;
                                              background-repeat: no-repeat;
                                              background-size: cover;
                                              background-position: center; 
                                              border-radius: 90px;
                                              color:white; background-color: #e4e7e8;
                                              "></span>
                            <span id="this-user"
                                  class="mdc-top-app-bar__title
                                  mdc-typography--body1
                                  "
                                  style="padding: 8px;padding-left:24px; text-transform: capitalize"
                                  >{{username}}</span>
                        </section>
                    </div>           
                </header>
                <div  id="lhs-menu" class="mdc-list  mdc-top-app-bar--fixed-adjust">

                    <a class="overview mdc-list-item mdc-list-item--activated" href="#overview">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
                        <span class="mdc-list-item__text">Overview</span>
                    </a>
                    <a  style="display:none" class="credits-and-debits mdc-list-item" href="#credits-and-debits" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">money</i>
                        <span class="mdc-list-item__text">Credits and Debits</span>
                    </a>
                    <a class="settlements mdc-list-item " href="#settlements" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">verified_user</i>
                        <span class="mdc-list-item__text">Settlements</span>
                    </a>
                    <a class="audit mdc-list-item" href="#audit" aria-current="page">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">remove_red_eye</i>
                        <span class="mdc-list-item__text">Audit</span>
                    </a>
                    
                    <div role="separator" class="mdc-list-divider"></div>

                </div>
            </div>
        </aside>
        <div class="mdc-drawer-app-content mdc-top-app-bar--fixed-adjust">
            <main class="main-content" id="main-content">

                <header class="mdc-top-app-bar  mdc-top-app-bar--fixed 
                        mdc-theme--primary
                        " 
                        style="background: white; box-shadow: 0 4px 4px -2px gray;"
                        id="app-bar-of-main-content">     
                    <div class="mdc-top-app-bar__row">
                        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                            <b id="header-title" class="mdc-top-app-bar__title ">
                                Overview
                            </b>
                        </section>
                    </div>           
                </header>
                <template id="overview-template">
                    <div id="{{username}}" class="panel">
                        <div class="mdc-card demo-card demo-ui-control">
                            <div class="mdc-card__primary-action demo-card__primary-action" style="display: flex;  flex-direction: row" tabindex="0">
                              <div id="this-user-avatar" class="mdc-card__media mdc-card__media--square demo-card__media" style=" width: 160px;  background-color: #dde1e7"></div>
                              <div class="demo-card__primary" style="padding:16px">
                                <h2 id="this-user" class="demo-card__title mdc-typography mdc-typography--headline6" style="text-transform: capitalize">Alice</h2>
                                <h3 id="this-role" class="demo-card__subtitle mdc-typography mdc-typography--subtitle2">BUYER,SELLER</h3>
                                <div class="demo-card__secondary mdc-typography mdc-typography--body2" >Public key: <span id="this-pk">203...</span></div>
                            
                              </div>
                            </div>
                            <div class="mdc-card__actions">
                              <div class="mdc-card__action-buttons">
                                <button id="overview-credits-debits-button" style="display:none" onclick="location.hash='credits-and-debits'" class="mdc-button mdc-card__action mdc-card__action--button">  <span class="mdc-button__ripple"></span> Credits and Debits</button>
                                <button onclick="location.hash='settlements'" class="mdc-button mdc-card__action mdc-card__action--button">  <span class="mdc-button__ripple"></span> Settlements</button>
                                <button onclick="location.hash='audit'" class="mdc-button mdc-card__action mdc-card__action--button">  <span class="mdc-button__ripple"></span> Audit</button>
                       
                              </div>
                              <div class="mdc-card__action-icons">
                                <button id="location"  class="mdc-icon-button material-icons mdc-card__action mdc-card__action--icon--unbounded" title="More options" data-mdc-ripple-is-unbounded="true">wifi</button>
                              </div>
                            </div>
                          </div>
                          <br/>
                          <div class="mdc-data-table" style="width:100%">
                            <table class="mdc-data-table__table" aria-label="Dessert calories" style="border-spacing: 10px 10px;">
                                <thead>
                                    <tr class="mdc-data-table__header-row">
                                        <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                                        <th class="mdc-data-table__header-cell" role="columnheader" scope="col">User</th>
                                        <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Role(s)</th>
                                        <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Payment Account Details</th>
                                    </tr>
                                </thead>
                                <tbody id="overview-table-body" class="mdc-data-table__content">
                                    <template id="overview-table-body-template">
                                        <tr class="mdc-data-table__row">
                                            <td  class="mdc-data-table__cell">
                                                <span class="hh-avatar mdc-typography--headline6" 
                                                      style="display: block;"
                                                      id="user-avatar"></span>
                                            </td>
                                            <td id="user"       class="mdc-data-table__cell">user</td>
                                            <td id="roles"    class="mdc-data-table__cell">roles</td>
                                            <td id="link"      class="mdc-data-table__cell">link</td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        
                    </div>
                </template>
                <template id="credits-and-debits-panel" >    
                    <div id="{{username}}" class="panel">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate	mdc-linear-progress--closed" aria-label="Example Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffering-dots"></div>
                            <div class="mdc-linear-progress__buffer"></div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>      
                        
                        <details>
                            <summary>
                                <div class="message-container" style="margin-left:16px">
                                    <div style="display: flex; align-items: center">
                                        <span class="hh-avatar mdc-typography--headline6" 
                                              id="credits-and-debits-user-avatar"></span>
                                        
                                        <span 
                                            id="credits-and-debits-user"
                                            class="mdc-typography--body" style="flex-grow:1;  padding-left:16px; ">
                                            {{username}}
                                        </span>
                                        <span
                                            id="credits-and-debits-seen"
                                            style="padding-right: 16px;"
                                            class="material-icons"
                                            >
                                            updated
                                        </span>
                                        
                                    </div>
                                </div>
                            </summary>
                            <div style="display: flex; flex-direction: row; padding: 24px;">
                                <div style="flex-grow: 1">
                                    <button id="settle-now-button" disabled class="mdc-button mdc-button--outlined">Settle</button>
                                    &nbsp; <small id="settle-total"></small>
                                </div>
                                <div >
                                    <button 
                                        
                                        id="new-credit-button"
                                        role="open-new-credit-button-dialog"
                                        class="mdc-button mdc-button--unelevated">
                                        new credit
                                    </button>
                                </div>
                            </div>
                            <div class="content"
                                 style="overflow-x: scroll"
                                 >
                                <div class="mdc-data-table" style="width:100%">
                                    <table class="mdc-data-table__table" aria-label="Dessert calories">
                                        <thead>
                                            <tr class="mdc-data-table__header-row">
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Payer</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Recipient</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Reference</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Amount</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">DateTime</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Actions</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="credit-table-body" class="mdc-data-table__content">
                                            <template id="credit-table-body-template">
                                                <tr class="mdc-data-table__row">
                                                    <td id="settlebox" class="mdc-data-table__cell"  style="text-align: center">
                                                        <div id="settle-check"  style="visibility: hidden;" class="mdc-checkbox">
                                                            <input type="checkbox"
                                                                   disabled
                                                                   class="mdc-checkbox__native-control"
                                                                   id="checkbox-1"/>
                                                            <div class="mdc-checkbox__background">
                                                              <svg class="mdc-checkbox__checkmark"
                                                                   viewBox="0 0 24 24">
                                                                <path class="mdc-checkbox__checkmark-path"
                                                                      fill="none"
                                                                      d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                                              </svg>
                                                              <div class="mdc-checkbox__mixedmark"></div>
                                                            </div>
                                                            <div class="mdc-checkbox__ripple"></div>
                                                          </div>
                                                    </td>
                                                    <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                                    <td id="payer"          class="mdc-data-table__cell">Alice</td>
                                                    <td id="recipient"      class="mdc-data-table__cell">Bob</td>
                                                    <td id="reference"      class="mdc-data-table__cell">A77U312</td>
                                                    <td id="amount"         class="mdc-data-table__cell" data-amount="120" data-currency="USD">$120</td>
                                                    <td id="date-time"           class="mdc-data-table__cell">13 Nov 9:21</td>
                                                    <td id="status"         class="mdc-data-table__cell">Pending</td>
                                                    <td id="action"         class="mdc-data-table__cell"></td>
                                                    <td id="notes"          class="mdc-data-table__cell">1 x XYZ Service</td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                        </details>
                    </div>
                </template>
                <template id="settlements-panel" >
                    <div id="{{username}}" class="panel">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate	mdc-linear-progress--closed" aria-label="Example Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffering-dots"></div>
                            <div class="mdc-linear-progress__buffer"></div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                              <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>      
                        <details>
                            <summary>
                                <div class="message-container" style="margin-left:16px; margin-right: 16px;">
                                    <div style="display: flex; align-items: center">
                                        <span class="hh-avatar mdc-typography--headline6" 
                                              id="settlements-user-avatar"></span>
                                        
                                        <span 
                                            id="settlements-user"
                                            class="mdc-typography--body" style="flex-grow:1;  padding-left:16px; ">
                                            {{username}}
                                        </span>
                                        <span
                                            id="settlements-seen"
                                            style="padding-right: 16px"
                                            class="material-icons"
                                            >
                                            updated
                                        </span>
                                    </div>
                                </div>
                            </summary>
                            <div class="content"
                                 style="overflow-x: scroll"
                                 >
                                <div class="mdc-data-table" style="width:100%">
                                    <table class="mdc-data-table__table" aria-label="">
                                        <thead>
                                            <tr class="mdc-data-table__header-row">
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Payer</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Recipient</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Reference</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Amount (USD)</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">DateTime</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Actions</th>
                                              
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="settlement-table-body" class="mdc-data-table__content">
                                            <template id="settlement-table-body-template">
                                                <tr class="mdc-data-table__row">
                                                    <td id="row-role" class="mdc-data-table__cell"  style="text-align: left">
                                                    </td>
                                                    <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                                    <td id="payer"          class="mdc-data-table__cell">Alice</td>
                                                    <td id="recipient"      class="mdc-data-table__cell">Bob</td>
                                                    <td id="reference"      class="mdc-data-table__cell">A77U312</td>
                                                    <td id="amount-net"     class="mdc-data-table__cell" style="text-align: right" data-amount="120" data-currency="USD">$120</td>
                                                    <td id="date-time"           class="mdc-data-table__cell">13 Nov</td>
                                                    <td id="action"         class="mdc-data-table__cell"></td>
                                                    <td id="status"         class="mdc-data-table__cell">Pending</td>
                                                    <td id="notes"          class="mdc-data-table__cell">1 x XYZ Service</td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                        </details>
                            
                    </div>
                </template>
                
                <template id="audit-table-template">
                    <div class="mdc-data-table" style="width:100%">
                        <table class="mdc-data-table__table" aria-label="Dessert calories">
                            <thead>
                                <tr class="mdc-data-table__header-row">
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">ThreadID</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Context</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">TopicId</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Date</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Time</th>
                                    <th></th>
                                </tr>
                            </thead>
                            
                            
                             <tbody id="audit-table-body" class="mdc-data-table__content">
                                    <template id="audit-table-body-template">
                                        <tr class="mdc-data-table__row">
                                            <td id="threadId"       class="mdc-data-table__cell overflow-elipsis">665</td>
                                            <td id="context"          class="mdc-data-table__cell">Credits</td>
                                            <td id="status"         class="mdc-data-table__cell">Pending</td>
                                            <td id="topicId"         class="mdc-data-table__cell">0.0.1004</td>
                                            <td id="createdDate"           class="mdc-data-table__cell">13 Nov</td>
                                            <td id="createdTime"           class="mdc-data-table__cell">09:31</td>
                                            <td id="action"              class="mdc-data-table__cell" style="text-align: right"> <a id="audit-table-row-expand" class="mdc-button"><i class="material-icons mdc-button__icon">remove_red_eye</i></a> </td>
                                        </tr>
                                    </template>
                            </tbody>
                        </table>
                    </div>
                </template>
                
                <template id="audit-thread-template">
                    <div class="panel">
                        <details>
                            <summary>
                                <div  style="display:flex; flex-direction: column; margin-left: 64px;">
                                    <div style="display: flex; ">
                                        <div style="padding: 16px"><b>Application Message ID:</b></div>
                                        <div style="padding: 16px" id="audit-thread-message-id">0.0.1010-1575314109-166076700</div>
                                    </div>
                                    <div style="padding: 16px; padding-top:8px" id="audit-thread-message-text">threadId: \"1575314119-166076700\"\ncredit ...</div>
                                </div>
                            </summary>
                            <div  class="content" style="overflow-x:scroll; background-color: #fafafa">
                                <pre  style="padding: 16px;" id="audit-thread-message-parts-json">
                                {"auditHCSMessages":[{"consensusTimeStampSeconds":1575314126,"consensusTimeStampNanos":919509001,"runningHash":"�_��:\u0005��]\u0004y9���\u0001\u0007)f��Ԓ����õ[_)9���+\u001E�\r9\u001FT�����","sequenceNumber":774,"message":"applicationMessageId {\n  validStart {\n    seconds: 1575314109\n    nanos: 166076700\n  }\n  accountID {\n    accountNum: 1010\n  }\n}\nbusinessProcessMessage: \"\\n\\0241575314119-166076700\\022:\\n\\005Alice\\022\\006Carlos\\032\\adsfafds\\\"\\b\\n\\003USD\\020\\241`*\\basfdsadf:\\0052 DecB\\00519:15\"\n","part":"1 of 1"}]}
                                </pre>
                            </div>
                        </details>
                    </div>
                </template>
                
                
                <div 
                    id="main-panel-holder"
                    class="flippanel mdc-top-app-bar--fixed-adjust mdc-typography--body2"
                     style='margin: 16px 32px;'
                    >
                </div>
            </main>
        </div>
        
        <div hh-include-html="dialogs/credits/new-credit-dialog.html"></div> 
        <script src="dialogs/credits/new-credit-dialog.js"></script>
        
        <div hh-include-html="dialogs/credits/confirm-credit-dialog.html"></div> 
        <script src="dialogs/credits/confirm-credit-dialog.js"></script>
        
        <div hh-include-html="dialogs/credits/settle-now-dialog.html"></div> 
        <script src="dialogs/credits/settle-now-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/confirm-settlement-dialog.html"></div> 
        <script src="dialogs/settlements/confirm-settlement-dialog.js"></script>
        
        
        <div hh-include-html="dialogs/settlements/select-paychannel-dialog.html"></div> 
        <script src="dialogs/settlements/select-paychannel-dialog.js"></script>
        
        
        <div hh-include-html="dialogs/settlements/accept-paychannel-dialog.html"></div> 
        <script src="dialogs/settlements/accept-paychannel-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/initialise-payment-dialog.html"></div> 
        <script src="dialogs/settlements/initialise-payment-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/confirm-payment-dialog.html"></div> 
        <script src="dialogs/settlements/confirm-payment-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/payment-made-dialog.html"></div> 
        <script src="dialogs/settlements/payment-made-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/confirm-settlement-receipt-dialog.html"></div> 
        <script src="dialogs/settlements/confirm-settlement-receipt-dialog.js"></script>
        
        <div hh-include-html="dialogs/settlements/settlement-completed-dialog.html"></div> 
        <script src="dialogs/settlements/settlement-completed-dialog.js"></script>
        
        <!-- pay sent was here -->
      
        <div id="snackbar" class="mdc-snackbar">
                <div class="mdc-snackbar__surface">
                    <div class="mdc-snackbar__label"
                        role="status"
                        aria-live="polite">
                    </div>
                    <div class="mdc-snackbar__actions">
                        <button type="button" class="mdc-button mdc-snackbar__action">Ok</button>
                    </div>
                </div>
        </div>
       
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
      
        
        <script>
            thisuserName = "";
            thisRoles = "";
            thisPK = "";
            thisPort="";
            allAddresses = [];
            buyerSellersAddress= [];
            paymentChannels = [];
            notificationList = []; //TODO: holds all incoming notifications - replace with session storage
            document.addEventListener("DOMContentLoaded", init);
            
            async function init ()  {
                //location.hash ='';
                wAddressBook =  await fetch('addressbook/appusers/');
                allAddresses = await wAddressBook.json();
                let responseWhoami =  await fetch('addressbook/me/');
                let whoami = await responseWhoami.json();
                thisuserName =  whoami.name;
                thisRoles = whoami.roles;
                thisAppId = whoami.appId;
                thisPK = whoami.publicKey;
                thisPort = allAddresses[thisAppId].port;
                document.documentElement.style.setProperty('--mdc-theme-primary', "#"+whoami.color);
                
                document.getElementById("this-user").innerHTML=whoami.name +"<span style='color:#aaa; font-size:12px;'> ("+whoami.roles+")</span>";
                document.getElementById("this-user-avatar").style.backgroundImage= "url(images/"+whoami.appId+".png)";
                if(thisRoles.includes("BUYER")) document.querySelector("#lhs-menu .credits-and-debits").style.display='flex';
                responsePaymentChannel = await fetch('addressbook/paychannel/');
                paymentChannels  = await responsePaymentChannel.json(); 
                responseAddressBookBs = await fetch('addressbook/buyerseller/');
                addressBookBs  = await responseAddressBookBs.json(); 
                buyerSellersAddress = addressBookBs;
                
                // redirect  subviews on browser refresh - only one atm
                switch(location.hash){
                    case "#audit-detail": 
                        location.hash="audit";
                        break;
                    default: //event.preventDefault();//do nothing'
                }
                
                renderMain();
                window.onhashchange = renderMain;
                
                async function renderMain(){
                    document.getElementById("main-panel-holder").innerHTML = "";
                    switch(location.hash){
                        case '#overview':
                            document.title= thisuserName + ' - Overview';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .overview").classList.add("mdc-list-item--activated");
                            document.getElementById("header-title").innerHTML = 'Overview';
                            await renderOverviewTab();
                            break;
                        case '#credits-and-debits':
                            document.title= thisuserName + ' - Credits and Debits';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .credits-and-debits").classList.add("mdc-list-item--activated");
                            document.querySelector("#lhs-menu .credits-and-debits").classList.remove("bold-text-notification");
                            document.getElementById("header-title").innerHTML = 'Outstanding Credits and Debits';
                            for(i=0; i < buyerSellersAddress.length; i++){
                                var userName = buyerSellersAddress[i].name;
                                await renderCreditsPanel(userName);
                            }
                            break;
                        case '#settlements':
                            document.title= thisuserName + ' - Settlements';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .settlements").classList.add("mdc-list-item--activated");
                            document.querySelector("#lhs-menu .settlements").classList.remove("bold-text-notification");
                           
                            
                            document.getElementById("header-title").innerHTML = 'Settlements';
                            for(i=0; i < buyerSellersAddress.length; i++){
                                var userName = buyerSellersAddress[i].name;
                                await renderSettlementsPanel(userName);
                            }
                            break;
                        case '#audit':
                            document.title=thisuserName + ' - Audit';
                            document.querySelectorAll("#lhs-menu .mdc-list-item").forEach(i=>i.classList.remove('mdc-list-item--activated'));
                            document.querySelector("#lhs-menu .audit").classList.add("mdc-list-item--activated");
                            document.getElementById("header-title").innerHTML = 'Audit';
                            renderAuditIndexTable();
                            break;
                        case '#audit-detail':break;
                        default: renderOverviewTab();
                    }
                    styleButtons();
                }
            };
            
            function hasRole(userName, roleName){
                return allAddresses.filter(f => f.name === userName)[0].roles.includes(roleName);
            }
            
       </script>
      

        <script> 
                                        
            /*
             * Routines to render the main sections, one function for each 
             * 
             * {@link renderOverviewTab()} 
             * {@link renderCreditsPanel()}  
             * {@link renderSettlementsPanel()
             * {@link renderAuditIndexTable() and it's sub-panel {@link openAuditThread()}
              */
            
            async function renderOverviewTab(){
                var panelTemplate = document.getElementById("overview-template");
                var clonedTableTemplate = panelTemplate.content.cloneNode(true);
                clonedTableTemplate.getElementById("this-user").innerHTML = thisuserName;
                clonedTableTemplate.getElementById("this-user-avatar").style.backgroundImage = 'url(images/'+thisAppId+'-100.png)';
                clonedTableTemplate.getElementById("this-role").innerHTML = thisRoles.replace(/,/g,", ");;;
                clonedTableTemplate.getElementById("this-pk").innerHTML = thisPK;
                if(!thisRoles.includes("PAYCHANNEL")) clonedTableTemplate.getElementById("overview-credits-debits-button").style.display='block';
                var url = window.location.protocol + "//" + window.location.hostname + ":" +thisPort;
                var tableBodyTemplate = clonedTableTemplate.getElementById("overview-table-body-template");
                var tableBody = clonedTableTemplate.getElementById("overview-table-body");
                
                for(z=0; z < allAddresses.length ; z++){
                    clonedRow = tableBodyTemplate.content.cloneNode(true);
                    clonedRow.getElementById("user").innerHTML = allAddresses[z].name;
                    clonedRow.getElementById("roles").innerHTML = allAddresses[z].roles.toLowerCase().replace(/,/g,", ");;
                    clonedRow.getElementById("roles").style.textTransform = "capitalize";
                    clonedRow.getElementById("link").innerHTML =  allAddresses[z].paymentAccountDetails ;
                    clonedRow.getElementById('user-avatar').style.backgroundImage = "url(images/" + allAddresses[z].appId + ".png)";
                    tableBody.appendChild(clonedRow);
                }     
                clonedTableTemplate.getElementById("location").onclick = function(){alert(url);};
                document.getElementById("main-panel-holder").appendChild(clonedTableTemplate);
                
            }
            
            async function  renderCreditsPanel(userName){
                var panelTemplate = document.getElementById("credits-and-debits-panel");
                var clonedPanelTemplate = panelTemplate.content.cloneNode(true);
                clonedPanelTemplate.querySelector(".panel").id=userName;    
                clonedPanelTemplate.getElementById("credits-and-debits-user").innerHTML = userName ;
                clonedPanelTemplate.getElementById("credits-and-debits-user-avatar").style.backgroundImage =  "url(images/"+addressBookBs.find(e => e.name === userName).appId+".png)";
                clonedPanelTemplate.getElementById("credits-and-debits-seen").innerHTML = (notificationList.filter(el => (el.payer === userName || el.recipient === userName) && el.context === "credits" ).length > 0 ? 'updated': '');
                clonedPanelTemplate.querySelector("details").addEventListener("toggle", e => {
                    o = notificationList.find(notification => (notification.payer === userName || notification.recipient === userName  ) && notification.context === "credits");
                    notificationList = notificationList.filter(notification => notification !== o);
                    document.querySelector("#"+userName+" #credits-and-debits-seen").innerHTML ='';
                });
                
                let userNameP = userName; {
                    clonedPanelTemplate.getElementById("new-credit-button").addEventListener("click",
                        function(){
                            openNewCreditDialog(userNameP);
                        }
                    );
                    clonedPanelTemplate.getElementById("settle-now-button").addEventListener("click",
                        function(){
                           openSettleNowDialog(userNameP);
                        }
                    );
                }
                var tableBody = clonedPanelTemplate.getElementById("credit-table-body");
                var tableBodyTemplate = clonedPanelTemplate.getElementById("credit-table-body-template");
                var responseCredits = await fetch(`credits/${userName}`);
                var i_UserCredits = await responseCredits.json();
                for(z=0; z < i_UserCredits.length ; z++){
                    clonedRow = tableBodyTemplate.content.cloneNode(true);
                    if(i_UserCredits[z].status === 'CREDIT_AGREED' ){
                        clonedPanelTemplate.getElementById("settle-now-button").removeAttribute("disabled");
                        clonedRow.getElementById("settle-check").style.visibility="visible";
                        clonedRow.getElementById("checkbox-1").checked="true";
                    }
                    threadId = i_UserCredits[z].threadId;
                    clonedRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                    clonedRow.getElementById("threadId").title = threadId;
                    clonedRow.getElementById("threadId").setAttribute("data-thread-id", threadId );
                    clonedRow.getElementById("recipient").innerHTML = i_UserCredits[z].recipientName;
                    clonedRow.getElementById("payer").innerHTML = i_UserCredits[z].payerName;
                    clonedRow.getElementById("reference").innerHTML = i_UserCredits[z].reference;
                    clonedRow.getElementById("amount").innerHTML = i_UserCredits[z].currency + ' '+ i_UserCredits[z].amount;
                    clonedRow.getElementById("amount").setAttribute("data-amount", i_UserCredits[z].amount );
                    clonedRow.getElementById("amount").setAttribute("data-currency", i_UserCredits[z].currency );
                    clonedRow.getElementById("date-time").innerHTML = i_UserCredits[z].createdDateTime;
                    clonedRow.getElementById("status").innerHTML =  i_UserCredits[z].displayStatus;
                    if(i_UserCredits[z].payerName === userName &&  i_UserCredits[z].status === 'CREDIT_PROPOSED'){
                      let threadId = i_UserCredits[z].threadId;
                      newButton = document.createElement("button");
                      newButton.innerHTML = "Accept";
                      newButton.classList.add("mdc-button");
                      newButton.classList.add("mdc-button--outlined");
                      newButton.addEventListener("click", function(){openConfirmCreditDialog(threadId,userName);});
                      clonedRow.getElementById("action").appendChild(newButton);
                    } 
                    clonedRow.getElementById("notes").innerHTML = i_UserCredits[z].additionalNotes;
                    tableBody.appendChild(clonedRow);
                }     
                if (document.getElementById(userName) === null) { // check if panel exists
                    document.getElementById("main-panel-holder").appendChild(clonedPanelTemplate);
                } else {
                    existingPanel = document.getElementById(userName);
                    clonedPanelTemplate.querySelector("details").setAttribute("open","true");
                    existingPanel.replaceWith(clonedPanelTemplate);
                }
                
                var thisUserPays = 0;
                var otherUserPays = 0;
                var threadIds=[];    
                document.querySelectorAll("#"+userName+" .mdc-data-table__row").forEach(
                    r=>{
                         if(r.cells.settlebox.querySelector("input").checked){
                             threadIds.push(r.cells.threadId.title);
                             rowAmount = 1*r.cells.amount.getAttribute("data-amount");
                             if (r.cells.payer.textContent!==userName){
                                thisUserPays += rowAmount ;
                            } else {
                                otherUserPays += rowAmount ; 
                            }
                         }
                     }
                );
        
                if(thisUserPays - otherUserPays) {
                    document.querySelector("#"+userName+" #settle-total").innerHTML = 
                        ("Total (USD): " + thisUserPays + " - " + otherUserPays + " = " + (thisUserPays - otherUserPays) );
                }
            } // render Credits panel
            
            
            async function  renderSettlementsPanel(userName){
                //if (document.getElementById(userName) === null) {
                var panelTemplate = document.getElementById("settlements-panel");
                var clonedPanelTemplate = panelTemplate.content.cloneNode(true);
                clonedPanelTemplate.querySelector(".panel").id=userName;    
                
                clonedPanelTemplate.getElementById("settlements-user-avatar").style.backgroundImage =  "url(images/"+addressBookBs.find(e => e.name === userName).appId+".png)";
                clonedPanelTemplate.getElementById("settlements-user").innerHTML = userName;

                clonedPanelTemplate.getElementById("settlements-seen").innerHTML = (notificationList.filter(el => (el.payer === userName || el.recipient === userName) && el.context === "settlements" ).length > 0 ? 'updated': '');
               
                clonedPanelTemplate.querySelector("details").addEventListener("toggle", e => {
                    o = notificationList.find(notification => (notification.payer === userName || notification.recipient === userName  ) && notification.context === "settlements");
                    notificationList = notificationList.filter(notification => notification !== o);
                    document.querySelector("#"+userName+" #settlements-seen").innerHTML ='';
                });
                  
                var tableBody = clonedPanelTemplate.getElementById("settlement-table-body");
                var tableBodyTemplate = clonedPanelTemplate.getElementById("settlement-table-body-template");

                var responseSettlements = await fetch(`settlements/${userName}`);
                var responseSettlementsL = await responseSettlements.json();
                
                for(z=0; z < responseSettlementsL.length ; z++){
                    i_Settlements = responseSettlementsL[z];
                    clonedRow = tableBodyTemplate.content.cloneNode(true);
                    clonedRow.getElementById("row-role").innerHTML = "<b>Settlement "+((z*1)+1)+"</b>"; 
                    let threadId = i_Settlements.threadId;
                        clonedRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                        clonedRow.getElementById("threadId").title = threadId;
                        clonedRow.getElementById("threadId").setAttribute("data-thread-id", threadId );
                        clonedRow.getElementById("recipient").innerHTML = i_Settlements.recipientName;
                        clonedRow.getElementById("payer").innerHTML = i_Settlements.payerName;
                        clonedRow.getElementById("reference").innerHTML = "";
                        clonedRow.getElementById("amount-net").innerHTML = "Net " + i_Settlements.netValue;
                        clonedRow.getElementById("date-time").innerHTML = i_Settlements.createdDateTime;
                        clonedRow.getElementById("status").innerHTML =  i_Settlements.displayStatus + (i_Settlements.paymentChannelName===null?"":" (with "+ i_Settlements.paymentChannelName +")");
                        clonedRow.getElementById("notes").innerHTML = i_Settlements.additionalNotes;
                        let newButton = document.createElement("button");
                            newButton.classList.add("mdc-button");
                            newButton.classList.add("mdc-button--outlined");
                            if(i_Settlements.payerName === userName && hasRole(thisuserName,'BUYER') &&  i_Settlements.status === 'SETTLE_PROPOSED'){ //SETTLEMENT_PROPOSED
                                newButton.innerHTML = "Accept";
                                newButton.addEventListener("click", function(){openConfirmSettlementDialog(threadId,userName);});
                            } else if (i_Settlements.payerName === thisuserName  && hasRole(thisuserName,'BUYER') &&  i_Settlements.status === 'SETTLE_AGREED'){
                                newButton.innerHTML = "Propose Pay Channel";
                                newButton.addEventListener("click", function(){openSelectPaychannelDialog(threadId,userName);});
                            } else if (i_Settlements.payerName === userName && hasRole(thisuserName,'BUYER') &&  i_Settlements.status === 'SETTLE_PAY_CHANNEL_PROPOSED'  ){
                                newButton.innerHTML = "Accept";
                                let cname = i_Settlements.paymentChannelName;
                                newButton.addEventListener("click", function(){openAcceptPaychannelDialog(threadId,userName,cname );});
                            } else if (i_Settlements.payerName === thisuserName  && hasRole(thisuserName,'BUYER') &&  i_Settlements.status === 'SETTLE_PAY_CHANNEL_AGREED'){
                                newButton.innerHTML = "Init Payment";
                                newButton.addEventListener("click", function(){openInitPayDialog(threadId,userName,i_Settlements.paymentChannelName );});
                            } else if ( hasRole(thisuserName,'PAYCHANNEL') && i_Settlements.status === 'SETTLE_PAY_PROPOSED'){
                                newButton.innerHTML = "Accept";
                                newButton.addEventListener("click", function(){openAcceptPaymentDialog(threadId,userName );});
                            }  else if (i_Settlements.payerName === thisuserName  &&  hasRole(thisuserName,'BUYER') && i_Settlements.status === 'SETTLE_PAY_ACK'){
                                newButton.innerHTML = "Request Receipt";
                                newButton.addEventListener("click", function(){openSettlementPaymentMadeDialog(threadId,userName,i_Settlements.paymentChannelName );});
                            } else if (i_Settlements.payerName === userName  && hasRole(thisuserName,'BUYER') &&  i_Settlements.status === 'SETTLE_RCPT_REQUESTED'){
                                newButton.innerHTML = "Confirm Receipt";
                                newButton.addEventListener("click", function(){openAcceptSettlePaymentMade(threadId,userName );});
                             } else if (i_Settlements.payerName === thisuserName  && hasRole(thisuserName,'BUYER') && i_Settlements.status === 'SETTLE_RCPT_CONFIRMED'){
                                newButton.innerHTML = "Settlement Completed";
                                newButton.addEventListener("click", function(){openSettlementCompletedDialog(threadId,userName,i_Settlements.paymentChannelName);});
                            }  

                            if(newButton.innerHTML!=="") clonedRow.getElementById("action").appendChild(newButton);
                        tableBody.appendChild(clonedRow);
                        
                    for(c in i_Settlements.credits){
                        credit = i_Settlements.credits[c];
                        clonedCreditRow = tableBodyTemplate.content.cloneNode(true);
                        clonedCreditRow.querySelector("tr").style.backgroundColor="#fafafa";
                        clonedCreditRow.querySelector("tr").style.border=0;
                        clonedCreditRow.getElementById("row-role").innerHTML = "Credit " + (c*1+1); 
                        
                        let threadId = credit.threadId;
                            clonedCreditRow.getElementById("threadId").innerHTML =formatThreadId(threadId);
                            clonedCreditRow.getElementById("threadId").title = threadId;
                            clonedCreditRow.getElementById("threadId").setAttribute("data-thread-id", threadId );
                            clonedCreditRow.getElementById("recipient").innerHTML = credit.recipientName;
                            clonedCreditRow.getElementById("payer").innerHTML = credit.payerName;
                            clonedCreditRow.getElementById("reference").innerHTML = credit.reference;
                            clonedCreditRow.getElementById("amount-net").innerHTML = credit.amount;
                            clonedCreditRow.getElementById("notes").innerHTML = credit.additionalNotes;
                            clonedCreditRow.getElementById("date-time").innerHTML = credit.createdDateTime;
                            clonedCreditRow.getElementById("status").innerHTML =  credit.displayStatus;
                            tableBody.appendChild(clonedCreditRow);
                    }
                }     
                if (document.getElementById(userName) === null) { // check if panel exists
                    document.getElementById("main-panel-holder").appendChild(clonedPanelTemplate);
                } else {
                    existingPanel = document.getElementById(userName);
                    clonedPanelTemplate.querySelector("details").setAttribute("open","true");
                    existingPanel.replaceWith(clonedPanelTemplate);
                }
            }
            
            async function renderAuditIndexTable(){
                var panelTemplate = document.getElementById("audit-table-template");
                var clonedTableTemplate = panelTemplate.content.cloneNode(true);
                let responseThreadIds = await fetch('audit/');
                let threadIdsJson = await  responseThreadIds.json();
                var tableBodyTemplate = clonedTableTemplate.getElementById("audit-table-body-template");
                var tableBody = clonedTableTemplate.getElementById("audit-table-body");
                threadIdsJson.threadIds.forEach(
                    t=>{
                        clonedRow = tableBodyTemplate.content.cloneNode(true);
                        tr = clonedRow.querySelector("tr");
                        tr.cells.threadId.textContent=formatThreadId(t.threadId);
                        tr.cells.context.textContent=t.context;
                        tr.cells.status.textContent=t.status;
                        tr.cells.topicId.textContent=t.topicId;
                        tr.cells.createdDate.textContent=t.createdDate;
                        tr.cells.createdTime.textContent=t.createdTime;
                        tr.querySelector("#audit-table-row-expand").onclick=function(){
                            openAuditThread(t.threadId);
                        };
                        tableBody.appendChild(tr);
                    }
                );
                document.getElementById("main-panel-holder").appendChild(clonedTableTemplate);
            }
            
            async function openAuditThread(threadId){
                event.preventDefault();
                main = document.getElementById('main-panel-holder');
                main.innerHTML="";
                document.getElementById('header-title').innerHTML = "<a href='#audit' class='mdc-button'><i style='font-size:26px;' class='material-icons'>arrow_back</i></a> <span style='position:relative;top:2px'>Audit Thread ID: " + threadId + " Details</span>";
                location.hash='audit-detail';
                let response = await fetch('audit/'+threadId);
                let responseJSON = await  response.json();
                let auditApplicationMessages = responseJSON.auditApplicationMessages;
                for (z=0; z < auditApplicationMessages.length ; z++) {
                    let response = await fetch('audit/'+threadId+"/"+auditApplicationMessages[z].applicationMessageId);
                    let responseJSON = await  response.json();
                    responseJSON = responseJSON.auditHCSMessages;
                    clonedTemplate = document.getElementById("audit-thread-template").content.cloneNode(true);
                    clonedTemplate.querySelector("#audit-thread-message-id").innerHTML=auditApplicationMessages[z].applicationMessageId;
                    clonedTemplate.querySelector("#audit-thread-message-text").innerHTML=syntaxHighlight(auditApplicationMessages[z].message);//.substring(0,180)+"...";
                    clonedTemplate.querySelector("#audit-thread-message-parts-json").innerHTML=syntaxHighlight(responseJSON);
                    main.appendChild(clonedTemplate);
                }
                return false;
            }
        </script>
        
        <script>
           /* 
            * Actions performed in response to websocket messages 
            */ 
                                                             
            var socket = new SockJS('/notifications');
                stompClient = Stomp.over(socket);  
                stompClient.debug = null;
                stompClient.connect({}, function(frame) {
                  
                    stompClient.subscribe('/notifications/messages', function(messageOutput) {
                        onStompMessage(JSON.parse(messageOutput.body));
                    });
            });
            
            /* Introspect a message and only update the relevant part of the UI
             * - makes left hand side menu item bold to indicate content change 
             */
            async function onStompMessage(messageOutput) {
                notificationList.push(messageOutput);
                notifyUi = messageOutput.context;
                switch (notifyUi) {
                    case "credits":  
                        if(location.hash !== '#credits-and-debits'){
                            document.querySelector("a.credits-and-debits").classList.add("bold-text-notification");
                        }
                        
                        if(location.hash === '#settlements'){
                            await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                   );
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable()(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        }
                        
                        break;
                    case "settlements":
                        if(location.hash !== '#settlements'){
                            document.querySelector("a.settlements").classList.add("bold-text-notification");
                        }
                        
                        if(location.hash === '#settlements'){
                            if (thisRoles.includes('PAYCHANNEL')){
                                await renderSettlementsPanel(messageOutput.payer);
                            } else {
                                await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                );
                            }
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                             styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable();
                            styleButtons();
                        }
                        break;
                    case "audits":
                        if(location.hash === '#settlements'){
                            await renderSettlementsPanel(
                                   messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                   );
                            styleButtons();
                        } else if (location.hash === '#credits-and-debits'){
                            await renderCreditsPanel(
                                    messageOutput.recipient===thisuserName?messageOutput.payer:messageOutput.recipient   
                                  );
                            styleButtons();
                        } else if (location.hash === '#audits'){
                            await renderAuditIndexTable();
                            styleButtons();
                        }
                        break;
                    case "admin":
                        location.reload();
                        break;
                    default: alert("wrong target element");
                }
                document.getElementById("notification-badge").innerHTML = document.getElementById("notification-badge").innerHTML * 1.0 + 1;
                document.getElementById("notification-badge").style.display="block";
                
            }
             
            function showSnackBarMessage(message){
                snackbarEl = document.getElementById("snackbar");
                snackbar = new mdc.snackbar.MDCSnackbar(snackbarEl);
                snackbar.labelText = message;
                snackbar.timeoutMs = 5000;
                snackbar.open();
            
            }
        </script>
        <script>    
            /* 
             * Actions for local app database functions 
             * (top right app-bar buttons)  
             */
            
    
            async function recreateData(){
                restore = confirm("This will delete your data and restore test data");
                if( restore){
                    await fetch('admin/deletedata');
                    await alert("We have sent this message to all participants. Please wait for the page to reload");

                }
            }
            
            async function saveData(){
                restore = confirm("This will take a snapshot of your current database");
                if( restore){
                    await fetch('admin/stash-database');
                    await alert("We have sent this message to all participants. Please wait for the page to reload");
        
                }
            }
            
            async function restoreData(){
                restore = confirm("This will restore the database from a previously taken snapshot");
                if( restore){
                    await fetch('admin/stash-pop-database');
                     await alert("We have sent this message to all participants. Please wait for the page to reload");
                 }
            } 
        </script>
        
        
        <script>
            /* Material Design component initialisations and visual sugar coating. */
           
            leftDrawer = mdc.drawer.MDCDrawer.attachTo(document.getElementById('left-drawer'));
            leftDrawer.open = true;
            topAppBar = mdc.topAppBar.MDCTopAppBar.attachTo(document.getElementById('app-bar'));
            topAppBar.setScrollTarget(document.getElementById('main-content'));
            topAppBar.listen('MDCTopAppBar:nav', () => {
                leftDrawer.open = !leftDrawer.open;
            });
            
            includeHTML();
            styleButtons();
            styleTextFields();
            styleTextFieldIcons();
       
            function styleButtons(){
                buttons = document.querySelectorAll('.mdc-button');
                for (i = 0; i < buttons.length; i++) {
                    buttons[i].innerHTML = "<span class='mdc-button__ripple'></span>" + buttons[i].innerHTML;
                    d_button = new mdc.ripple.MDCRipple(buttons[i]);
                }
            }

            function styleSwitches(){
                switches = document.querySelectorAll('.mdc-switch');
                for (i = 0; i < switches.length; i++) {
                    switchControl_ = new mdc.switchControl.MDCSwitch(switches[i]);
                }
               
            }

            function styleTextFields(){
                textFields = document.querySelectorAll('.mdc-text-field');
                for (i = 0; i < textFields.length; i++) {
                    //textFields[i].insertAdjacentHTML("afterend",'<div class="mdc-text-field-helper-line"><div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg">helpme</div></div>');
                    textFields[i].innerHTML = "<span class='mdc-line-ripple'></span>" + textFields[i].innerHTML;
                    d_textFieldHelperText = new mdc.textField.MDCTextFieldHelperText(textFields[i].parentElement.querySelector('.mdc-text-field-helper-text'));
                    d_textField = new mdc.textField.MDCTextField(textFields[i]);
                }
            }
            
            function styleTextFieldIcons(){
                textFieldIcons = document.querySelectorAll('.mdc-text-field-icon');
                for (i = 0; i < textFieldIcons.length; i++) {
                    d_textFieldIcon = new mdc.textFieldIcon.MDCTextFieldIcon(textFieldIcons[i]);
                }
            }
    
            function styleDataTables(){
                dataTables = document.querySelector('.mdc-data-table');
                for (i = 0; i < dataTables.length; i++) {
                    d_textFieldIcon = new mdc.textFieldIcon.MDCTextFieldIcon(textFieldIcons[i]);
                    d_dataTable = new mdc.dataTable.MDCDataTable(dataTables[i]);
                }
            }
            
            function syntaxHighlight(json) {
                
                if (typeof json !== 'string') {
                     json = JSON.stringify(json, undefined, 2);
                }
               
                json = json.replace(/([^ -~-\n]+)/g, "Ħ");
                json = json.replace(/\\n/g, '\n\t\t');
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }
            
            function formatThreadId(threadId){
                 return   threadId.substring(0,2) + "..." + threadId.substring(threadId.length - 4,threadId.length);
            }
            
            function restoreInput(recipient) {
                el = document.getElementById(recipient);
                el.style.opacity=1;
                el.style.pointerEvents =  'auto';
                el.querySelector(".mdc-linear-progress").classList.add('mdc-linear-progress--closed');
            }
            
            function preventInput(recipient) {
                el = document.getElementById(recipient);
                el.style.opacity=0.4;
                el.style.pointerEvents =  'none';
                el.querySelector(".mdc-linear-progress").classList.remove('mdc-linear-progress--closed');
            }
        </script>
        
    </body>
</html>